import Tkinter as tk
from Tkinter import *
import ttk
import tkFileDialog
import webbrowser
import hashlib
import os

import config
import updater


## Functions
def openReadme():
    webbrowser.open(config.readMe)

def openDictionary():
    if not os.path.exists(config.dictionaryList):
        print("file does not exist")
        mainDictionary = open("dictionary.txt", "w+")

    webbrowser.open(config.dictionaryList)

def browseDictionary():
    file = tkFileDialog.askopenfilename()
    config.dictionaryFile = file
    dictionaryEntry.delete(0, END)
    dictionaryEntry.insert(0, config.dictionaryFile)

## Antivirus functions

def scanFileHash():
    if not os.path.exists(config.dictionaryList):
        mainDictionary = open("dictionary.txt", "w+")

    file = open(config.dictionaryList, "r")
    infected = False
    with file as f:
        for line in f:
            hash = line.strip()
            if hash == config.hash:
                infected = True
                break
        f.close()

    if infected:
        result.config(text="Infected!")
    else:
        result.config(text="Safe!")


def getFileHash():
    try:
        with open(config.directory) as fileToHash:
            contents = fileToHash.read()
            hash = hashlib.md5(contents).hexdigest()
            config.hash = hash
            hashOutput.config(text="MD5 Hash: " + config.hash)
    except:
        hashOutput.config(text="Invalid file selected")


def browseFile():
    file = tkFileDialog.askopenfilename()
    config.directory = file
    directory.delete(0, END)
    directory.insert(0, file)


##### window, notebook, and frames
myWidth = 375
myHeight = 250

root = tk.Tk()
root.geometry("375x200")
root.title("Supr Simple AV")
root.iconbitmap("icon.ico")

notebook = ttk.Notebook(root)
notebook.pack()

antivirusFrame = Frame(notebook)
settingsFrame = Frame(notebook)

antivirusFrame.pack(fill="both", expand=1)
settingsFrame.pack(fill="both", expand=1)

##### creating widgets #####

# buttons
fileSelector = Button(antivirusFrame, text="Browse file", command=browseFile)
fileHasher = Button(antivirusFrame, text="Get MD5 Hash", command=getFileHash)
hashScanner = Button(antivirusFrame, text="Scan Hash", command=scanFileHash)

dictionarySelector = Button(settingsFrame, text="Browse File", command=browseDictionary)
enterDictionary = Button(settingsFrame, text="Add dictionary", command=updater.enterDictionary)
openDictionary = Button(settingsFrame, text="Open Dictionary File", command=openDictionary)
openReadme = Button(settingsFrame, text="Open Readme File", command=openReadme)
enterHash = Button(settingsFrame, text="Enter Hash", command=lambda : updater.enterHash(hashEntry.get()))

# Labels
title = Label(antivirusFrame, text="Supr Simpl AV")
hashOutput = Label(antivirusFrame, text="Hash goes here...")
result = Label(antivirusFrame, text="Results go here...")

selectorInstructions = Label(settingsFrame, text="Select an .html/.txt file:")
hexInstructions = Label(settingsFrame, text="Enter a hash:")
settingsResult = Label(settingsFrame, text="")

# Entries
directory = Entry(antivirusFrame, borderwidth=3, width=40)

dictionaryEntry = Entry(settingsFrame, borderwidth=3, width=40)
hashEntry = Entry(settingsFrame, borderwidth=3, width=40)

##### grids ######

# Buttons
fileSelector.grid(row=1, column=1, padx=3, pady=5)
fileHasher.grid(row=3, column=1, padx=3, pady=5)
hashScanner.grid(row=5, column=1, padx=3, pady=5)

dictionarySelector.grid(row=1, column=1, padx=3, pady=3)
enterDictionary.grid(row=2, column=0, padx=3, pady=3)
openDictionary.grid(row = 2, column = 1, padx = 3, pady = 3)
openReadme.grid(row = 3, column = 1, padx = 3, pady = 3)
enterHash.grid(row=5, column=0, padx=3, pady=3)

# Labels
title.grid(row=0, column=0, padx=3, pady=5)
result.grid(row=5, column=0, padx=3, pady=5)

hexInstructions.grid(row=3, column=0, padx=3, pady=3)
selectorInstructions.grid(row=0, column=0, padx=3, pady=3)
settingsResult.grid(row=5, column=1, padx=3, pady=3)

# Entries
directory.grid(row=1, column=0, padx=3, pady=5)
hashOutput.grid(row=3, column=0, padx=3, pady=5)

dictionaryEntry.grid(row=1, column=0, padx=3, pady=3)
hashEntry.grid(row=4, column=0, padx=3, pady=3)

# adding frames to notebook
notebook.add(antivirusFrame, text="Antivirus")
notebook.add(settingsFrame, text="Settings")

root.mainloop()
